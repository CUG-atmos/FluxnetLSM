<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LaThuile processing • FluxnetLSM</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="LaThuile processing">
<meta property="og:description" content="FluxnetLSM">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FluxnetLSM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/FLUXNET2015_processing.html">FLUXNET2015 processing</a>
    </li>
    <li>
      <a href="../articles/lathuile_processing.html">LaThuile processing</a>
    </li>
    <li>
      <a href="../articles/meta_data.html">Meta-data description</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/aukkola/FluxnetLSM/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>LaThuile processing</h1>
                        <h4 data-toc-skip class="author">Koen
Hufkens</h4>
            
            <h4 data-toc-skip class="date">2022-05-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/aukkola/FluxnetLSM/blob/HEAD/vignettes/lathuile_processing.Rmd" class="external-link"><code>vignettes/lathuile_processing.Rmd</code></a></small>
      <div class="hidden name"><code>lathuile_processing.Rmd</code></div>

    </div>

    
    
<p>Example data conversion using the Harvard site using La Thuile
synthesis.</p>
<p>See FLUXNET2015/example_conversion_single_site.R for the
corresponding FLUXNE2015 example.</p>
<p>Converts useful variables from a La Thuile spreatsheet format into
two netcdf files, one for fluxes, and one for met forcings.</p>
<p>The user must provide the input directory path, output directory path
and site code. For La Thuile datasetname must be set to “LaThuile” as
the code defaults to FLUXNET2015. All other settings are optional. This
example extracts La Thuile years complying with “Fair Use” policy. All
other options are set to their default values.</p>
<div class="section level2">
<h2 id="single-site">Single site<a class="anchor" aria-label="anchor" href="#single-site"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/aukkola/FluxnetLSM" class="external-link">FluxnetLSM</a></span><span class="op">)</span> 

<span class="co">#clear R environment</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span>all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>


<span class="co">#############################</span>
<span class="co">###--- Required inputs ---###</span>
<span class="co">#############################</span>

<span class="co">#--- User must define these ---#</span>

<span class="co">#Fluxnet site ID (see http://fluxnet.fluxdata.org/sites/site-list-and-pages/)</span>
<span class="va">site_code</span>   <span class="op">&lt;-</span> <span class="st">"US-Ha1"</span>
<span class="va">datasetname</span> <span class="op">&lt;-</span> <span class="st">"LaThuile"</span>

<span class="co"># This directory should contain appropriate data from </span>
<span class="co"># http://fluxnet.fluxdata.org/data/la-thuile-dataset/</span>
<span class="va">in_path</span> <span class="op">&lt;-</span> <span class="st">"./Inputs"</span>

<span class="co">#Outputs will be saved to this directory</span>
<span class="va">out_path</span> <span class="op">&lt;-</span> <span class="st">"./Outputs"</span>


<span class="co">#--- Automatically retrieve all Fluxnet files in input directory ---#</span>

<span class="co"># Input Fluxnet data file (using FULLSET in this example, see R/Helpers.R for details)</span>
<span class="va">infile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluxnet_files.html">get_fluxnet_files</a></span><span class="op">(</span><span class="va">in_path</span>, <span class="va">site_code</span>, datasetname<span class="op">=</span><span class="va">datasetname</span><span class="op">)</span>


<span class="co">##########################</span>
<span class="co">###--- Run analysis ---###</span>
<span class="co">##########################</span>

<span class="fu"><a href="../reference/convert_fluxnet_to_netcdf.html">convert_fluxnet_to_netcdf</a></span><span class="op">(</span>site_code <span class="op">=</span> <span class="va">site_code</span>, infile <span class="op">=</span> <span class="va">infile</span>, 
                          out_path <span class="op">=</span> <span class="va">out_path</span>, datasetname<span class="op">=</span><span class="va">datasetname</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multiple-sites">Multiple sites<a class="anchor" aria-label="anchor" href="#multiple-sites"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R">

<span class="co">#--- Automatically retrieve all Fluxnet files in input directory ---#</span>

<span class="co"># Input Fluxnet data files</span>
<span class="va">infile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluxnet_files.html">get_fluxnet_files</a></span><span class="op">(</span><span class="va">in_path</span>, datasetname<span class="op">=</span><span class="va">datasetname</span><span class="op">)</span>

<span class="co">#Get site codes</span>
<span class="va">site_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_path_site_code.html">get_path_site_code</a></span><span class="op">(</span><span class="va">infile</span><span class="op">)</span><span class="op">)</span>

<span class="co">#Reorganise input files by site</span>
<span class="va">infiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">site_codes</span>, <span class="kw">function</span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="fu"><a href="../reference/get_fluxnet_files.html">get_fluxnet_files</a></span><span class="op">(</span><span class="va">in_path</span>, site_code<span class="op">=</span><span class="va">site</span>,
                                                              datasetname<span class="op">=</span><span class="va">datasetname</span><span class="op">)</span><span class="op">)</span>



<span class="co">##########################</span>
<span class="co">###--- Run analysis ---###</span>
<span class="co">##########################</span>


<span class="co">#Loops through sites</span>
<span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">site_code</span>, <span class="va">infile</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/convert_fluxnet_to_netcdf.html">convert_fluxnet_to_netcdf</a></span><span class="op">(</span>site_code <span class="op">=</span> <span class="va">site_code</span>,
                              infile <span class="op">=</span> <span class="va">infile</span>,
                              out_path <span class="op">=</span> <span class="va">out_path</span>,
                              datasetname <span class="op">=</span> <span class="va">datasetname</span>
    <span class="op">)</span>
  <span class="op">)</span><span class="op">}</span>,
  site_code <span class="op">=</span> <span class="va">site_codes</span>,
  infile <span class="op">=</span> <span class="va">infiles</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multiple-sites-parallel">Multiple sites (parallel)<a class="anchor" aria-label="anchor" href="#multiple-sites-parallel"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">#--- Automatically retrieve all Fluxnet files in input directory ---#</span>

<span class="co"># Input Fluxnet data files</span>
<span class="va">infile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluxnet_files.html">get_fluxnet_files</a></span><span class="op">(</span><span class="va">in_path</span>, datasetname<span class="op">=</span><span class="va">datasetname</span><span class="op">)</span>

<span class="co">#Get site codes</span>
<span class="va">site_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_path_site_code.html">get_path_site_code</a></span><span class="op">(</span><span class="va">infile</span><span class="op">)</span><span class="op">)</span>

<span class="co">#Reorganise input files by site</span>
<span class="va">infiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">site_codes</span>, <span class="kw">function</span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="fu"><a href="../reference/get_fluxnet_files.html">get_fluxnet_files</a></span><span class="op">(</span><span class="va">in_path</span>, site_code<span class="op">=</span><span class="va">site</span>,
                                                               datasetname<span class="op">=</span><span class="va">datasetname</span><span class="op">)</span><span class="op">)</span>



<span class="co">##########################</span>
<span class="co">###--- Run analysis ---###</span>
<span class="co">##########################</span>


<span class="co">#Initialise clusters (using 2 cores here)</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">'cl.cores'</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="co">#Import variables to cluster</span>
<span class="fu">clusterExport</span><span class="op">(</span><span class="va">cl</span>, <span class="st">"out_path"</span><span class="op">)</span>
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"conv_opts"</span><span class="op">)</span><span class="op">)</span>  <span class="op">{</span><span class="fu">clusterExport</span><span class="op">(</span><span class="va">cl</span>, <span class="st">"conv_opts"</span><span class="op">)</span><span class="op">}</span>
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"datasetversion"</span><span class="op">)</span><span class="op">)</span>   <span class="op">{</span><span class="fu">clusterExport</span><span class="op">(</span><span class="va">cl</span>, <span class="st">"datasetversion"</span><span class="op">)</span><span class="op">}</span>
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"datasetname"</span><span class="op">)</span><span class="op">)</span>   <span class="op">{</span><span class="fu">clusterExport</span><span class="op">(</span><span class="va">cl</span>, <span class="st">"datasetname"</span><span class="op">)</span><span class="op">}</span>
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"plot"</span><span class="op">)</span><span class="op">)</span>             <span class="op">{</span><span class="fu">clusterExport</span><span class="op">(</span><span class="va">cl</span>, <span class="st">"plot"</span><span class="op">)</span><span class="op">}</span>


<span class="co">#Loops through sites</span>
<span class="fu">clusterMap</span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, <span class="kw">function</span><span class="op">(</span><span class="va">site_code</span>, <span class="va">infile</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/aukkola/FluxnetLSM" class="external-link">FluxnetLSM</a></span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/convert_fluxnet_to_netcdf.html">convert_fluxnet_to_netcdf</a></span><span class="op">(</span>
      site_code <span class="op">=</span> <span class="va">site_code</span>,
      infile <span class="op">=</span> <span class="va">infile</span>,
      out_path <span class="op">=</span> <span class="va">out_path</span>,
      datasetname <span class="op">=</span> <span class="va">datasetname</span>
    <span class="op">)</span>,
    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span><span class="op">)</span>
<span class="op">}</span>,
site_code <span class="op">=</span> <span class="va">site_codes</span>,
infile <span class="op">=</span> <span class="va">infiles</span><span class="op">)</span>


<span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
</code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Ukkola Anna.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
